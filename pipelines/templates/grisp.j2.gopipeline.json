{% macro scm(id, destination, name) -%}
{
    "scm_id": "{{ id }}",
    "destination": "{{ destination }}",
    "filter": {
        "ignore": [],
        "whitelist": []
    },
    "configuration": [],
    "name": "{{ name }}",
    "type": "plugin"
},
{%- endmacro %}

{% macro git(url, destination, name) -%}
{
    "url": "{{ url }}",
    "branch": "master",
    "shallow_clone": false,
    "filter": {
        "ignore": [],
        "whitelist": []
    },
    "destination": "{{ destination }}",
    "auto_update": true,
    "name": "{{ name }}",
    "type": "git"
},
{%- endmacro %}

{
    "group": "grisp",
    "name": "{{ pipeline_name }}",
    "label_template": "${COUNT}",
    "lock_behavior": "none",
    "environment_variables": [],
    "parameters": [],
    "materials": [
        {% if grisp_material == 'git' %}
            {{ git('https://github.com/grisp/grisp.git', 'grisp', 'grisp-git') }}
        {% endif %}
        {% if grisp_material == 'fb' %}
            {{ scm('asdf123-e100-4e52-8ebf-a21193f47bf1', 'grisp', 'grisp-fb') }}
        {% endif %}
        {% if grisp_material == 'pr' %}
            {{ scm('7797947b-a4eb-458f-b655-e3a3017c6a07', 'grisp', 'grisp-pr') }}
        {% endif %}

        {% if rebar3_grisp_material == 'git' %}
            {{ git('https://github.com/grisp/rebar3_grisp.git', 'rebar3_grisp', 'rebar3_grisp-git') }}
        {% endif %}
        {% if rebar3_grisp_material == 'fb' %}
            {{ scm('as1123-e100-4e52-8ebf-a21193f47bf1', 'rebar3_grisp', 'rebar3_grisp-fb') }}
        {% endif %}
        {% if rebar3_grisp_material == 'pr' %}
             {{ scm('a0a55708-e100-4e52-8ebf-a21193f47bf1', 'rebar3_grisp', 'rebar3_grisp-pr') }}
        {% endif %}

        {% if grisp_tools_material == 'git' %}
            {{ git('https://github.com/grisp/grisp_tools.git', 'grisp_tools', 'grisp_tools-git') }}
        {% endif %}
        {% if grisp_tools_material == 'fb' %}
            {{ scm('sfdf123-e100-4e52-8ebf-a21193f47bf1', 'grisp_tools', 'grisp_tools-fb') }}
        {% endif %}
        {% if grisp_tools_material == 'pr' %}
            {{ scm('b0a55708-e100-4e52-8ebf-a21193f47bf1', 'grisp_tools', 'grisp_tools-pr') }}
        {% endif %}
        {% if fetch_toolchain %}
        {
            "pipeline": "grisp-software",
            "stage": "build",
            "name": "grisp-software",
            "type": "dependency"
        },
        {% endif %}
        {
            "url": "https://github.com/grisp/grisp-gocd.git",
            "branch": "master",
            "shallow_clone": false,
            "filter": {
                "ignore": [],
                "whitelist": []
            },
            "destination": ".gocd",
            "auto_update": true,
            "name": "gocd",
            "type": "git"
        }
    ],
    "stages": [
        {
            "name": "build",
            "fetch_materials": true,
            "never_cleanup_artifacts": false,
            "clean_working_directory": true,
            "approval": {
                "type": "success",
                "users": [],
                "roles": []
            },
            "environment_variables": [],
            "jobs": [
                {
                    "name": "build_grisp_project",
                    "environment_variables": [
                        {
                            "name": "GO_API_TOKEN",
                            "encrypted_value": "AES:jrW5vV/Il7aaMequSv5V7Q\u003d\u003d:Nb+eeokNuRaX50tM+YRyedDxnhSME/16YO/0uSs8GjjQ7uqZ9W0ZBUTV0gYFMg0k"
                        }
                    ],
                    "tabs": [],
                    "resources": [],
                    "artifacts": [
                        {% if build_otp %}
                        {
                            "source": "grisp_otp*.tar.gz",
                            "destination": "otp",
                            "type": "build"
                        },
                        {% endif %}
                        {
                            "source": "grisp_release*.tar.gz",
                            "destination": "grisp_release/",
                            "type": "build"
                        }
                    ],
                    "properties": [],
                    "run_instance_count": "0",
                    "timeout": 0.0,
                    "tasks": [
                        {% if fetch_toolchain %}
                        {
                            "source": "toolchain",
                            "is_source_a_file": false,
                            "destination": "",
                            "pipeline": "grisp-software",
                            "stage": "build",
                            "job": "build.sh",
                            "artifact_origin": "gocd",
                            "run_if": "passed",
                            "type": "fetch"
                        },
                        {% endif %}
                        {
                            "command": "/bin/bash",
                            "timeout": -1.0,
                            "arguments": [
                                ".gocd/install-env.sh"
                            ],
                            "run_if": "passed",
                            "type": "exec"
                        },
                        {
                            "command": "/bin/bash",
                            "timeout": -1.0,
                            "arguments": [
                                ".gocd/grisp-project.sh",
                                "--erlang-version={{ version }}"{% if grisp_material %}, "--use-grisp-material"{% endif %}{% if rebar3_grisp_material %}, "--use-rebar3-grisp-material"{% endif %}{% if grisp_tools_material %}, "--use-grisp-tools-material"{% endif %}{% if not fetch_toolchain %}, "--toolchain-from-s3"{% endif %}{% if not build_otp %}, "--prebuilt-otp"{% endif %}
                            ],
                            "run_if": "passed",
                            "type": "exec"
                        }
                    ]
                }
            ]
        }
    ]
}
